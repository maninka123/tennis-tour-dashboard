<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tennis Notification System</title>
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <main class="page-shell">
    <header class="page-header">
      <div>
        <p class="kicker">Tennis Intelligence Suite</p>
        <h1>Tennis Notification System</h1>
        <p class="subtitle">Build smarter ATP/WTA alert rules with guided filters, instant suggestions, and branded email delivery.</p>
      </div>
      <div class="status-stack">
        <span id="smtpStatusPill" class="pill">SMTP: checking...</span>
        <span id="schedulerPill" class="pill neutral">Scheduler: --</span>
      </div>
    </header>

    <section class="grid two-col">
      <article class="card elevated">
        <h2>Delivery Settings</h2>
        <p class="muted">Set recipient, test your setup, and control scheduled runs.</p>
        <div class="field-row">
          <label for="emailInput">Recipient Email</label>
          <input id="emailInput" type="email" placeholder="you@example.com">
        </div>
        <div class="actions">
          <button id="saveSettingsBtn" class="btn primary with-tip" data-tip="Save recipient email and delivery setup.">Save Settings</button>
          <button id="runNowBtn" class="btn with-tip" data-tip="Run all enabled rules immediately and send matching notifications.">Run Rules Now</button>
          <button id="testEmailBtn" class="btn with-tip" data-tip="Send a sample email to confirm SMTP is working.">Send Test Email</button>
          <div id="taskProgressInline" class="task-progress-inline is-hidden" aria-live="polite">
            <div class="task-progress-track">
              <div id="taskProgressBar" class="task-progress-bar"></div>
            </div>
            <span id="taskProgressText" class="task-progress-text">Working...</span>
          </div>
        </div>
        <p id="settingsMessage" class="feedback"></p>
      </article>

      <article class="card elevated">
        <h2>Quick Guide</h2>
        <div class="tips-grid">
          <div class="tip-card">
            <h3>1. Pick Trigger</h3>
            <p>Choose event type, tour, and round logic.</p>
          </div>
          <div class="tip-card">
            <h3>2. Add Focus</h3>
            <p>Filter by category, tournament, players, and optional custom filters.</p>
          </div>
          <div class="tip-card">
            <h3>3. Go Live</h3>
            <p>Save and test email. Active rules run automatically.</p>
          </div>
        </div>
      </article>
    </section>

    <section class="card rule-builder-card">
      <div class="card-head">
        <h2>Rule Builder</h2>
      </div>
      <form id="ruleForm" class="rule-form" novalidate>
        <input id="ruleIdInput" type="hidden">
        <input id="conditionGroupInput" type="hidden" value="all">
        <input id="trackedPlayerInput" type="hidden" value="">

        <div class="step-flow" aria-label="Rule builder flow">
          <div id="stepChip1" class="step-chip active"><span>1</span>Core Trigger</div>
          <div class="step-arrow">‚Üí</div>
          <div id="stepChip2" class="step-chip"><span>2</span>Scope & Event Settings</div>
          <div class="step-arrow">‚Üí</div>
          <div id="stepChip3" class="step-chip"><span>3</span>Delivery & Save</div>
        </div>
        <p id="builderProgressHint" class="builder-progress-hint">Start with the required fields below.</p>

        <div id="layerCore" class="builder-layer">
          <div class="section-title">Core Trigger <span class="field-status required">Required</span></div>
          <div class="grid three-col core-trigger-grid">
            <div class="field-row">
              <label for="ruleNameInput">Rule Name <span class="field-status required">Required</span></label>
              <input id="ruleNameInput" type="text" placeholder="Example: ATP Finals + SF and above" required>
            </div>
            <div class="field-row">
              <label for="eventTypeInput">Event Type <span class="field-status required">Required</span></label>
              <select id="eventTypeInput">
                <option value="upcoming_match">üìÖ Upcoming Match</option>
                <option value="live_match_starts">üî¥ Live Match Starts</option>
                <option value="set_completed">üéæ Set Completed</option>
                <option value="match_result">‚úÖ Match Result</option>
                <option value="upset_alert">‚ö†Ô∏è Upset Alert</option>
                <option value="close_match_deciding_set">üî• Close Match / Deciding Set</option>
                <option value="player_reaches_round">üèÅ Player Reaches Round</option>
                <option value="tournament_stage_reminder">üèü Tournament-Stage Reminder</option>
                <option value="surface_specific_result">üå± Surface-Specific Result</option>
                <option value="time_window_schedule_alert">‚è∞ Time-Window Schedule Alert</option>
                <option value="ranking_milestone">üìà Ranking Milestone</option>
                <option value="title_milestone">üèÜ Title Milestone</option>
                <option value="head_to_head_breaker">‚öîÔ∏è Head-to-Head Breaker</option>
                <option value="tournament_completed">üèÜ Tournament Completed</option>
              </select>
              <p id="eventTypeHint" class="hint-text">Choose what should trigger this rule.</p>
            </div>
            <div class="field-row">
              <label for="tourInput">Tour <span class="field-status required">Required</span></label>
              <select id="tourInput">
                <option value="both">Both</option>
                <option value="atp">ATP</option>
                <option value="wta">WTA</option>
              </select>
            </div>
          </div>
          <div class="wizard-actions">
            <button id="step1ConfirmBtn" type="button" class="btn primary">‚úì Confirm Step 1</button>
          </div>
        </div>

        <div id="layerScope" class="builder-layer is-hidden">
          <div class="section-title">Scope & Event Settings <span class="field-status conditional">Required/Optional</span></div>

          <div id="scopeLogicSection" class="ghost-section">
            <div class="ghost-heading">Trigger Logic</div>
            <div class="grid two-col trigger-logic-grid">
              <div class="field-row scope-group" data-scope="round_filters">
                <label for="roundModeInput">Round Filter Mode <span class="field-status optional">Optional</span></label>
                <select id="roundModeInput">
                  <option value="any">Any Round</option>
                  <option value="min">Round or Above</option>
                  <option value="exact">Exact Round</option>
                </select>
              </div>
              <div class="field-row scope-group" data-scope="round_filters">
                <label for="roundValueInput">Round Value <span class="field-status conditional">Required for Min/Exact</span></label>
                <select id="roundValueInput">
                  <option value="">üéØ Optional</option>
                  <option value="R128">R128 ¬∑ Round of 128</option>
                  <option value="R64">R64 ¬∑ Round of 64</option>
                  <option value="R32">R32 ¬∑ Round of 32</option>
                  <option value="R16">R16 ¬∑ Round of 16</option>
                  <option value="QF">QF ¬∑ Quarterfinal</option>
                  <option value="SF">SF ¬∑ Semifinal</option>
                  <option value="F">F ¬∑ Final</option>
                </select>
              </div>
            </div>
          </div>

          <div id="scopeFiltersSection" class="ghost-section">
            <div class="ghost-heading">Scope Filters</div>
            <div class="scope-filter-logic-row">
              <div class="field-row scope-group" data-scope="categories">
                <label for="categoriesInput">Tournament Categories <span class="field-status optional">Optional</span><span class="field-help with-tip" data-tip="Tip: use commas to add multiple categories. Example: grand_slam, atp_1000, wta_500">i</span></label>
                <div class="smart-input-wrap">
                  <input id="categoriesInput" type="text" autocomplete="off" placeholder="grand_slam, atp_1000, wta_500">
                  <div id="categoriesDropdown" class="smart-dropdown"></div>
                </div>
              </div>
              <div class="scope-link-box">
                <span class="scope-link-label">Logic</span>
                <div class="scope-link-toggle" data-link-index="0">
                  <button type="button" class="scope-link-btn active" data-value="all">AND</button>
                  <button type="button" class="scope-link-btn" data-value="any">OR</button>
                </div>
              </div>
              <div class="field-row scope-group" data-scope="tournaments">
                <label for="tournamentsInput">Specific Tournaments <span class="field-status optional">Optional</span><span class="field-help with-tip" data-tip="Tip: use commas to add multiple tournaments. Example: Australian Open, Indian Wells">i</span></label>
                <div class="smart-input-wrap">
                  <input id="tournamentsInput" type="text" autocomplete="off" placeholder="Australian Open, Indian Wells">
                  <div id="tournamentsDropdown" class="smart-dropdown"></div>
                </div>
              </div>
              <div class="scope-link-box">
                <span class="scope-link-label">Logic</span>
                <div class="scope-link-toggle" data-link-index="1">
                  <button type="button" class="scope-link-btn active" data-value="all">AND</button>
                  <button type="button" class="scope-link-btn" data-value="any">OR</button>
                </div>
              </div>
              <div class="field-row scope-group" data-scope="players">
                <label for="playersInput">Players <span class="field-status optional">Optional</span><span class="field-help with-tip" data-tip="Tip: use commas to add multiple players. For tracked-player events, the first player is treated as the tracked player.">i</span></label>
                <div class="smart-input-wrap">
                  <input id="playersInput" type="text" autocomplete="off" placeholder="Carlos Alcaraz, Iga Swiatek">
                  <div id="playersDropdown" class="smart-dropdown"></div>
                </div>
              </div>
            </div>

            <div class="grid two-col">
              <div class="field-row scope-group" data-scope="extra_conditions">
                <label>Extra Filters (max 3) <span class="field-status optional">Optional</span></label>
                <div id="conditionsList" class="condition-list"></div>
                <button id="addConditionBtn" type="button" class="btn small with-tip" data-tip="Add advanced condition like surface, player name, or round rank.">+ Add Filter</button>
              </div>
            </div>
          </div>

          <div id="eventParamsSection" class="ghost-section">
            <div class="ghost-heading">Event Parameters</div>
            <div id="eventParamsGrid" class="grid three-col">
              <div class="field-row param-group" data-param="set_number">
                <label for="paramSetNumber">Set Number <span class="field-status optional">Optional</span><span class="field-help with-tip" data-tip="Set completion threshold. Example: 2 means alert when at least 2 sets are completed.">i</span></label>
                <input id="paramSetNumber" type="hidden" value="1">
                <div id="paramSetThresholdRow" class="set-threshold-row" role="group" aria-label="Completed set threshold">
                  <button type="button" class="set-threshold-btn" data-set-value="1">1</button>
                  <button type="button" class="set-threshold-btn" data-set-value="2">2</button>
                  <button type="button" class="set-threshold-btn" data-set-value="3">3</button>
                  <button type="button" class="set-threshold-btn" data-set-value="4">4</button>
                  <button type="button" class="set-threshold-btn" data-set-value="5">5</button>
                </div>
                <p class="hint-text">Select one or more boxes. 1 + 2 means alert when 2 sets are completed.</p>
              </div>
              <div class="field-row param-group" data-param="upset_min_rank_gap">
                <label for="paramUpsetGap">Min Rank Gap <span class="field-status optional">Optional</span><span class="field-help with-tip" data-tip="Minimum ranking difference for an upset alert. Higher value = only bigger upsets.">i</span></label>
                <select id="paramUpsetGap">
                  <option value="10">10</option>
                  <option value="20" selected>20</option>
                  <option value="30">30</option>
                  <option value="40">40</option>
                  <option value="50">50</option>
                </select>
              </div>
              <div class="field-row param-group" data-param="deciding_mode">
                <label for="paramDecidingMode">Close-Match Mode <span class="field-status optional">Optional</span><span class="field-help with-tip" data-tip="Choose how to detect close matches: deciding set, third/fifth set, or any tiebreak.">i</span></label>
                <select id="paramDecidingMode">
                  <option value="deciding_set">Deciding Set</option>
                  <option value="third_or_fifth">Third or Fifth Set</option>
                  <option value="tiebreak">Any Tiebreak Set</option>
                </select>
              </div>
              <div class="field-row param-group" data-param="ranking_milestone">
                <label for="paramRankingMilestone">Ranking Milestone <span class="field-status optional">Optional</span><span class="field-help with-tip" data-tip="Trigger when selected players reach Top 100/50/20/10 or Career High.">i</span></label>
                <select id="paramRankingMilestone">
                  <option value="top_100">Top 100</option>
                  <option value="top_50">Top 50</option>
                  <option value="top_20">Top 20</option>
                  <option value="top_10">Top 10</option>
                  <option value="career_high">Career High</option>
                </select>
              </div>
              <div class="field-row param-group" data-param="title_target">
                <label for="paramTitleTarget">Title Target <span class="field-status optional">Optional</span><span class="field-help with-tip" data-tip="Total career titles target for Title Milestone alerts.">i</span></label>
                <input id="paramTitleTarget" type="number" min="1" max="200" value="1">
              </div>
              <div class="field-row param-group" data-param="rival_player">
                <label for="paramRivalPlayerInput">Rival Player <span class="field-status required">Required</span><span class="field-help with-tip" data-tip="Opponent used in Head-to-Head Breaker rules.">i</span></label>
                <div class="smart-input-wrap">
                  <input id="paramRivalPlayerInput" type="text" autocomplete="off" placeholder="Type rival name">
                  <div id="paramRivalPlayerDropdown" class="smart-dropdown"></div>
                </div>
              </div>
              <div class="field-row param-group" data-param="h2h_min_losses">
                <label for="paramH2HLosses">Min Prior H2H Losses <span class="field-status optional">Optional</span><span class="field-help with-tip" data-tip="How many consecutive losses must be broken before alerting.">i</span></label>
                <select id="paramH2HLosses">
                  <option value="1">1</option>
                  <option value="2" selected>2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                </select>
              </div>
              <div class="field-row param-group" data-param="surface_value">
                <label for="paramSurfaceValue">Surface <span class="field-status required">Required</span><span class="field-help with-tip" data-tip="Only match results on this surface will trigger the rule.">i</span></label>
                <select id="paramSurfaceValue">
                  <option value="">Select surface</option>
                  <option value="hard">Hard</option>
                  <option value="clay">Clay</option>
                  <option value="grass">Grass</option>
                  <option value="indoor">Indoor</option>
                  <option value="carpet">Carpet</option>
                </select>
              </div>
              <div class="field-row param-group" data-param="window_hours">
                <label for="paramWindowHours">Window Hours <span class="field-status optional">Optional</span><span class="field-help with-tip" data-tip="Alert when upcoming matches start within the next N hours.">i</span></label>
                <select id="paramWindowHours">
                  <option value="2">2 Hours</option>
                  <option value="6">6 Hours</option>
                  <option value="12">12 Hours</option>
                  <option value="24" selected>24 Hours</option>
                  <option value="48">48 Hours</option>
                </select>
              </div>
            </div>

            <div class="grid two-col">
              <div class="field-row param-group" data-param="stage_rounds">
                <label>Tournament Stages <span class="field-status required">Required</span><span class="field-help with-tip" data-tip="Choose which stages (QF/SF/F) should trigger stage-reminder alerts.">i</span></label>
                <div class="inline-check-row">
                  <label class="checkbox-wrap"><input id="paramStageQF" type="checkbox" checked><span>QF</span></label>
                  <label class="checkbox-wrap"><input id="paramStageSF" type="checkbox" checked><span>SF</span></label>
                  <label class="checkbox-wrap"><input id="paramStageF" type="checkbox" checked><span>F</span></label>
                </div>
              </div>
              <div class="field-row param-group" data-param="emit_on_first_seen">
                <label class="checkbox-wrap compact"><input id="paramEmitFirstSeen" type="checkbox" checked><span>Trigger immediately if milestone already met</span><span class="field-help with-tip" data-tip="If ON, sends right away when the milestone is already satisfied at first evaluation.">i</span></label>
              </div>
            </div>
          </div>
          <div class="wizard-actions">
            <button id="step2NextBtn" type="button" class="btn primary">‚úì Confirm Step 2</button>
            <button id="step2SkipBtn" type="button" class="btn">Skip to Step 3</button>
          </div>
        </div>

        <div id="layerDelivery" class="builder-layer is-hidden">
          <div class="section-title">Delivery & Controls <span class="field-status conditional">Channels Required</span></div>
          <div class="grid three-col">
            <div class="field-row">
              <label for="severityInput">Severity <span class="field-status optional">Optional</span></label>
              <select id="severityInput">
                <option value="important">Important</option>
                <option value="normal" selected>Normal</option>
                <option value="digest">Digest</option>
              </select>
            </div>
            <div class="field-row">
              <label for="cooldownInput">Cooldown (minutes) <span class="field-status optional">Optional</span><span class="field-help with-tip" data-tip="Prevents repeat alerts from this rule for the selected time after a send. Set 0 to disable cooldown.">i</span></label>
              <input id="cooldownInput" type="number" min="0" max="1440" value="0">
            </div>
            <div class="field-row">
              <label>Channels <span class="field-status required">Required</span></label>
              <div class="inline-check-row">
                <label class="checkbox-wrap"><input id="channelEmail" type="checkbox" checked><span>Email</span></label>
                <label class="checkbox-wrap"><input id="channelTelegram" type="checkbox"><span>Telegram</span></label>
                <label class="checkbox-wrap"><input id="channelDiscord" type="checkbox"><span>Discord</span></label>
                <label class="checkbox-wrap"><input id="channelWebPush" type="checkbox"><span>Web Push</span></label>
              </div>
            </div>
          </div>

          <div class="grid quiet-hours-grid">
            <div class="field-row quiet-toggle-cell">
              <label class="checkbox-wrap compact">
                <input id="quietHoursEnabledInput" type="checkbox">
                <span>Quiet Hours Enabled</span>
              </label>
            </div>
            <div class="field-row quiet-hours-group">
              <label for="quietStartHourInput">Quiet Start Hour <span class="field-status optional">Optional</span></label>
              <select id="quietStartHourInput">
                <option value="21">21:00</option>
                <option value="22">22:00</option>
                <option value="23" selected>23:00</option>
                <option value="0">00:00</option>
              </select>
            </div>
            <div class="field-row quiet-hours-group">
              <label for="quietEndHourInput">Quiet End Hour <span class="field-status optional">Optional</span></label>
              <select id="quietEndHourInput">
                <option value="5">05:00</option>
                <option value="6">06:00</option>
                <option value="7" selected>07:00</option>
                <option value="8">08:00</option>
              </select>
            </div>
            <div class="field-row quiet-hours-group">
              <label for="timezoneOffsetInput">Timezone Offset <span class="field-status optional">Optional</span></label>
              <select id="timezoneOffsetInput">
                <option value="-08:00">UTC-08:00</option>
                <option value="-05:00">UTC-05:00</option>
                <option value="+00:00" selected>UTC+00:00</option>
                <option value="+05:30">UTC+05:30</option>
                <option value="+10:00">UTC+10:00</option>
              </select>
            </div>
          </div>
        </div>

        <p id="ruleRequiredHint" class="feedback hint-text"></p>
        <div id="saveActions" class="actions is-hidden">
          <button id="saveRuleBtn" type="submit" class="btn primary with-tip" data-tip="Save or update this rule.">Save Rule</button>
        </div>
        <p id="ruleMessage" class="feedback"></p>
      </form>
    </section>

    <section class="grid two-col rules-history-layout">
      <article class="card">
        <div class="card-head">
          <h2>Saved Rules</h2>
          <span id="ruleCount" class="pill neutral">0</span>
        </div>
        <div id="rulesContainer" class="rule-list"></div>
      </article>

      <article class="card">
        <div class="card-head">
          <h2>Activity Log</h2>
          <button id="clearHistoryBtn" type="button" class="btn small with-tip" data-tip="Clear local activity history for this notification app.">Clear</button>
        </div>
        <div id="historyContainer" class="history-list"></div>
      </article>
    </section>
  </main>

  <div id="confirmDialog" class="confirm-dialog is-hidden" role="dialog" aria-modal="true" aria-labelledby="confirmDialogTitle">
    <div class="confirm-card">
      <p class="confirm-kicker">Rule Deletion</p>
      <h3 id="confirmDialogTitle" class="confirm-title">Delete this rule?</h3>
      <p id="confirmDialogBody" class="confirm-body">This action removes the rule permanently.</p>
      <div class="confirm-actions">
        <button id="confirmCancelBtn" type="button" class="btn">Keep Rule</button>
        <button id="confirmOkBtn" type="button" class="btn danger">Delete Rule</button>
      </div>
    </div>
  </div>

  <div id="resultDialog" class="confirm-dialog is-hidden" role="dialog" aria-modal="true" aria-labelledby="resultDialogTitle">
    <div class="confirm-card result-card">
      <p class="confirm-kicker">Execution Summary</p>
      <h3 id="resultDialogTitle" class="confirm-title">Completed</h3>
      <p id="resultDialogBody" class="confirm-body">Action completed.</p>
      <div id="resultSummaryList" class="result-summary-list"></div>
      <p id="resultDialogTimer" class="result-timer"></p>
      <div class="confirm-actions">
        <button id="resultCloseBtn" type="button" class="btn primary">Close</button>
      </div>
    </div>
  </div>

  <datalist id="conditionValueSuggestions"></datalist>

  <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
